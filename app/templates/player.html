<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Metadata and stylesheets -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player</title>
    <!-- Video.js, HLS.js, and Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://vjs.zencdn.net/7.10.2/video-js.min.css" rel="stylesheet">
    <script src="https://vjs.zencdn.net/7.10.2/video.min.js"></script>
    <!-- videojs-contrib-ads -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-ads/6.8.0/videojs-contrib-ads.min.js"></script>
    <!-- Google IMA SDK -->
    <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
    <!-- Video.js IMA Plugin -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/videojs-ima/1.10.1/videojs.ima.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-ima/1.10.1/videojs.ima.min.js"></script>
    <!-- Custom styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: black; /* Ensure background is black to match video */
        }
        #video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .video-js {
            width: 100% !important;
            height: 100% !important;
            z-index: 1;
        }
        .video-js .vjs-big-play-button {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .vjs-controls-hidden .vjs-control-bar {
            display: none !important;
        }
        .vjs-control-bar {
            padding-top: 15px;
            padding-bottom: 15px;
            background-color: rgba(26, 26, 26, 0.7) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            height: 60px !important;
        }
       
        .video-js .vjs-play-progress {
            background-color: #00a0ff;
        }
        .video-js .vjs-progress-holder {
            background-color: rgba(255, 255, 255, 0.3);
        }
        .show-title-player {
            font-size: 24px;
            margin: 0 0 5px 0;
            margin-top: 20px;
            color: white;
            font-weight: bold;
        }
        .episode-title-player {
            font-size: 18px;
            margin-top: -12px;
            color: #ccc;
        }
        
        .video-js .vjs-big-play-button .vjs-icon-placeholder:before {
            content: '' !important;
            background-image: url('/static/images/play.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border: none !important;
            width: 200px;
            height: 200px;
        }

        .video-js .vjs-big-play-button {
            background-color: transparent;
            width: 200px;
            height: 200px;
            border-color: transparent;
        }

        #ad-container {
            position: fixed; /* Changed from absolute to fixed */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999999; /* Increased z-index to ensure it's above Video.js's fullscreen elements */
        }

        @media screen and (min-width: 768px) {
            .video-js .vjs-big-play-button {
                display: none;
            }
        }

        .video-js .vjs-big-play-button:hover {
            display: none;
        }
        .video-js.vjs-has-autoplay .vjs-big-play-button {
            display: none !important;
        }

        #back-button {
            background-color: rgba(0, 0, 0, 0.6);
            color: #fff;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            display: flex;
            align-items: center;
            transition: background-color 0.3s ease;
            z-index: 1002; /* Ensure it's above other elements */
            pointer-events: auto; /* Ensure it can receive pointer events */
        }
    
        #back-button:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
    
       /* Arrange show-info-header elements in a row */
        .show-info-header {
            display: flex;
            align-items: center;
            gap: 20px; /* Space between back button and show info */
            position: relative;
            z-index: 1001; /* Ensure it's above other elements */
        }
    
        /* Optional: Style for show-info div */
        .show-info {
            display: flex;
            flex-direction: column;
        }

        /* Hide Video.js's native spinner when 'hide-videojs-spinner' class is applied */
        .hide-videojs-spinner .vjs-loading-spinner {
            display: none;
        }

        /* Spinner Overlay Styles */
        #spinner {
            position: fixed; /* Changed from absolute to fixed */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001; /* Above ad-container (999999) and other elements */
            display: none; /* Hidden by default */
        }

        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.3); /* Light grey with transparency */
            border-top: 5px solid rgb(15, 169, 231); /* Blue border-top */
            border-radius: 50%;
            width: 50px; /* Match Video.js spinner size */
            height: 50px; /* Match Video.js spinner size */
            animation: spin 1s linear infinite; /* Match Video.js spinner animation */
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* New CSS to hide the big play button on mobile when playing */
        .hide-big-play-button .vjs-big-play-button {
            display: none !important;
        }

        /* Fullscreen Styles Enhancements */
        .video-js.vjs-fullscreen .show-info-header {
            /* Example: Adjust positioning when in fullscreen */
            top: 10px;
            left: 10px;
        }

        /* Optional: Style adjustments for fullscreen mode */
        .video-js.vjs-fullscreen .vjs-control-bar {
            /* Make control bar more prominent in fullscreen */
            background-color: rgba(0, 0, 0, 0.8) !important;
        }
    </style>
</head>
<body>
    <div id="video-container">
        <video id="my-video" class="video-js vjs-default-skin" controls preload="auto" playsinline>
            <source src="{{ episode_url }}" type="application/x-mpegURL">
        </video>
        <div id="episode-name" class="episode-name-overlay">
            <div class="show-info-header">
                <button id="back-button" onclick="goBack()" aria-label="Go Back">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <div class="show-info">
                    <h1 class="show-title-player">{{ show.name }}</h1>
                    <h2 class="episode-title-player">{{ episode.name }}</h2>
                </div>
            </div>
        </div>
    </div>
    <div id="ad-container"></div> <!-- Moved outside of video-container -->
    <!-- Loading Spinner -->
    <div id="spinner">
        <div class="spinner"></div>
    </div>
    
    <script>
        let player;
        let scteMarkers = {{ scte_markers|safe }};
        let lastPlayedCuePoint = -1;
        let adPlaying = false;
        let mouseTimer;
        let adTimeout; // For fallback

        function generateSessionId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function getRandomPublicIP() {
            const firstOctet = Math.floor(Math.random() * (223 - 1)) + 1; // 1-223
            const octets = [
                firstOctet,
                Math.floor(Math.random() * 256),
                Math.floor(Math.random() * 256),
                Math.floor(Math.random() * 256)
            ];
            return octets.join('.');
        }

        async function getCurrentIP(useRandom = true) {
            if (useRandom) {
                return getRandomPublicIP();
            }
            
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Error fetching IP:', error);
                return '0.0.0.0';
            }
        }

        function customEncode(str) {
            return encodeURIComponent(str)
                .replace(/%5B/g, '[')
                .replace(/%5D/g, ']');
        }

        function getOS() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            if (/windows phone/i.test(userAgent)) {
                return "Windows Phone";
            }
            if (/android/i.test(userAgent)) {
                return "Android";
            }
            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                return "iOS";
            }
            if (/Win/i.test(userAgent)) {
                return "Windows";
            }
            if (/Mac/i.test(userAgent)) {
                return "MacOS";
            }
            if (/Linux/i.test(userAgent)) {
                return "Linux";
            }
            return "Unknown";
        }

        function getBrowser() {
            const userAgent = navigator.userAgent;
            if (userAgent.indexOf("Firefox") > -1) {
                return "Firefox";
            } else if (userAgent.indexOf("SamsungBrowser") > -1) {
                return "Samsung Internet";
            } else if (userAgent.indexOf("Opera") > -1 || userAgent.indexOf("OPR") > -1) {
                return "Opera";
            } else if (userAgent.indexOf("Trident") > -1) {
                return "Internet Explorer";
            } else if (userAgent.indexOf("Edge") > -1) {
                return "Edge";
            } else if (userAgent.indexOf("Chrome") > -1) {
                return "Chrome";
            } else if (userAgent.indexOf("Safari") > -1) {
                return "Safari";
            }
            return "Unknown";
        }

        async function getAdTagUrl() {
            const timestamp = Date.now();
            const cacheBuster = `${timestamp}${Math.random().toString(36).substring(2)}`;

            const currentIP = await getCurrentIP(true); // Changed to true to use random IP

            // Gather additional dynamic data
            const episodeName = "{{ episode.name }}";
            const showName = "{{ show.name }}";
            const episodeId = "{{ episode.id }}"; // Assuming you have an episode ID
            const showId = "{{ show.id }}"; // Assuming you have a show ID
            const referrer = document.referrer || 'direct';
            const pageURL = window.location.href;
            const contentGenre = "{{ episode.genre }}"; // Assuming genre is available
            const userAgent = navigator.userAgent;
            const language = navigator.language || 'en';

            // Device Information
            const screenWidth = window.screen.width;
            const screenHeight = window.screen.height;
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const deviceType = isMobile() ? 'mobile' : 'desktop';
            const os = getOS();
            const browser = getBrowser();
            const sitePage = window.location.href;
            // Content Length in seconds
            const contentLength = Math.floor(player.duration()) || 0;

            // Define the parameters in order
            const parameters = [
                { name: 'site_id', placeholder: '49382', value: '49382' },
                { name: 'site_page', placeholder: '[SITE_PAGE]', value: sitePage },
                { name: 'format', placeholder: 'vast', value: 'vast' },
                { name: 'pod_duration', placeholder: '[POD_DURATION]', value: '60' },
                { name: 'cb', placeholder: '[CACHEBUSTER]', value: cacheBuster },
                { name: 'ip', placeholder: '[IP]', value: currentIP },
                { name: 'ua', placeholder: '[UA]', value: userAgent },
                { name: 'player_height', placeholder: '[HEIGHT]', value: player.el().offsetHeight },
                { name: 'player_width', placeholder: '[WIDTH]', value: player.el().offsetWidth },
                { name: 'is_lat', placeholder: '[LIMITED_AD_TRACKING]', value: 'false' },
                { name: 'site_name', placeholder: '[CHANNEL_NAME]', value: 'JLTV' },
                { name: 'content_cat', placeholder: '[CONTENT_CAT]', value: 'Faith' },
                { name: 'device_type', placeholder: '[DEVICE_TYPE]', value: deviceType },
                { name: 'session_id', placeholder: '[SESSION_ID]', value: generateSessionId() },
            ];

            // Build the VAST URL
            let vastUrl = 'https://obs.ads.ottera.tv/v1/s2s-hb?';

            // Build the query string with custom encoding
            const queryParams = parameters.map(param => {
                const value = (param.value !== undefined && param.value !== null) ? param.value : param.placeholder;
                const encodedName = encodeURIComponent(param.name);
                const encodedValue = customEncode(value);
                return `${encodedName}=${encodedValue}`;
            });

            vastUrl += queryParams.join('&');

            console.log("VAST URL:", vastUrl); // For debugging purposes

            return vastUrl;
        }

        async function initializePlayer() {
            disposePlayer();

            let isMobileDevice = isMobile();

            player = videojs('my-video', {
                autoplay: !isMobileDevice,
                muted: !isMobileDevice,
                controls: true,
                playsinline: true,
                preload: 'auto',
                fullscreen: {
                    enabled: false,
                    iosNative: false
                }
            });

            const episodeNameOverlay = document.getElementById('episode-name');
            const episodeNameH2 = episodeNameOverlay.querySelector('h2');
            episodeNameH2.textContent = "{{ episode.name }}";

            player.ready(async function() {
                const adTagUrl = await getAdTagUrl();
                player.ima({
                    adTagUrl: adTagUrl,
                    debug: false, // Set to true for debugging
                    id: 'my-video',
                    adLabel: 'Advertisement',
                    // Additional options if needed
                });

                // Handle ad events with correct event names
                player.on('adsready', function() {
                    console.log('Ads ready');
                    // Optionally, you can show the spinner here if needed
                });

                player.on('adstart', function() {
                    console.log('Ad started');
                    adPlaying = true;
                    hideSpinner(); // Hide spinner when ad starts
                    player.el().style.pointerEvents = 'none';
                    player.controls(false);
                });

                player.on('adend', function() {
                    console.log('Ad ended');
                    adPlaying = false;
                    hideSpinner(); // Hide spinner when ad ends
                    player.el().style.pointerEvents = 'auto';
                    player.controls(true);
                });

                player.on('adskip', function() {
                    console.log('Ad skipped');
                    adPlaying = false;
                    hideSpinner(); // Hide spinner when ad is skipped
                    player.el().style.pointerEvents = 'auto';
                    player.controls(true);
                });

                player.on('aderror', function() {
                    console.log('Ad error');
                    adPlaying = false;
                    hideSpinner(); // Hide spinner on ad error
                    player.el().style.pointerEvents = 'auto';
                    player.controls(true);
                });

                // Handle play and pause events
                player.on('play', function() {
                    showEpisodeName();
                    setTimeout(hideEpisodeName, 3000);
                });

                player.on('pause', hideEpisodeName);

                player.on('ended', function() {
                    console.log('Video ended');
                    // Optionally play a post-roll ad
                    player.ima.playAdBreak();
                });

                // Handle time-based ad requests
                player.on('timeupdate', handleTimeUpdate);
                player.on('seeking', handleSeeking);

                // Hide the big play button on mobile devices when play starts
                if (isMobileDevice) {
                    player.on('play', function() {
                        const videoContainer = document.getElementById('video-container');
                        if (videoContainer) {
                            videoContainer.classList.add('hide-big-play-button');
                        }
                    });
                }

                // Custom Fullscreen Button
                addCustomFullscreenButton();

                // Handle fullscreen changes to ensure ads play correctly
                document.addEventListener('fullscreenchange', handleDocumentFullscreenChange);
                document.addEventListener('fullscreenerror', handleFullscreenError);
            });

            // Add event listeners for mouse and touch interactions
            player.el().addEventListener('mousemove', handleMouseMove);
            player.el().addEventListener('mouseenter', handleMouseEnter);
            player.el().addEventListener('mouseleave', handleMouseLeave);
            player.el().addEventListener('touchstart', handleTouch);
            player.el().addEventListener('touchmove', handleTouch);
            player.el().addEventListener('touchend', handleTouch);
        }

        function disposePlayer() {
            if (player) {
                player.off('timeupdate', handleTimeUpdate);
                player.off('seeking', handleSeeking);
                player.off('play');
                player.off('pause');
                player.off('ended');
                player.dispose();
                player = null;
            }
        }

        function handleTimeUpdate() {
            if (adPlaying) {
                return;
            }
            const currentTime = player.currentTime();
            scteMarkers.forEach((marker, index) => {
                if (marker.time > 0 && currentTime >= marker.time && index > lastPlayedCuePoint && !adPlaying) {
                    adPlaying = true;
                    lastPlayedCuePoint = index;
                    player.ima.requestAds();
                    showSpinner(); // Show spinner when requesting ads

                    // Implement a fallback timeout in case ad events are not fired
                    clearTimeout(adTimeout);
                    adTimeout = setTimeout(() => {
                        if (adPlaying) {
                            console.warn('Ad request timed out. Hiding spinner and restoring controls.');
                            adPlaying = false;
                            hideSpinner();
                            player.el().style.pointerEvents = 'auto';
                            player.controls(true);
                        }
                    }, 10000); // 10 seconds timeout
                }
            });
        }

        function handleSeeking() {
            const currentTime = player.currentTime();
            const bufferTime = 0.5;

            lastPlayedCuePoint = scteMarkers.findIndex(marker => marker.time > currentTime) - 1;
            lastPlayedCuePoint = Math.max(-1, Math.min(lastPlayedCuePoint, scteMarkers.length - 1));

            const nextCuePoint = scteMarkers[lastPlayedCuePoint + 1];
            if (nextCuePoint && currentTime >= nextCuePoint.time - bufferTime && !adPlaying) {
                adPlaying = true;
                player.ima.requestAds();
                showSpinner(); // Show spinner when requesting ads due to seeking

                // Implement a fallback timeout in case ad events are not fired
                clearTimeout(adTimeout);
                adTimeout = setTimeout(() => {
                    if (adPlaying) {
                        console.warn('Ad request timed out. Hiding spinner and restoring controls.');
                        adPlaying = false;
                        hideSpinner();
                        player.el().style.pointerEvents = 'auto';
                        player.controls(true);
                    }
                }, 10000); // 10 seconds timeout
            }
        }

        function handleMouseMove() {
            showEpisodeName();
            resetMouseTimer();
        }

        function handleMouseEnter() {
            showEpisodeName();
            resetMouseTimer();
        }

        function handleMouseLeave() {
            hideEpisodeName();
            clearTimeout(mouseTimer);
        }

        function resetMouseTimer() {
            clearTimeout(mouseTimer);
            mouseTimer = setTimeout(() => {
                hideEpisodeName();
            }, 2000);
        }

        function goBack() {
            window.history.back();
        }

        function showEpisodeName() {
            const episodeNameOverlay = document.getElementById('episode-name');
            episodeNameOverlay.style.opacity = '1';
        }

        function hideEpisodeName() {
            const episodeNameOverlay = document.getElementById('episode-name');
            episodeNameOverlay.style.opacity = '0';
        }

        function handleTouch() {
            showEpisodeName();
            resetMouseTimer();
        }

        function showSpinner() {
            const spinner = document.getElementById('spinner');
            if (spinner) {
                spinner.style.display = 'block';
            }
            const videoPlayer = document.querySelector('.video-js');
            if (videoPlayer) {
                videoPlayer.classList.add('hide-videojs-spinner');
            }
        }

        function hideSpinner() {
            const spinner = document.getElementById('spinner');
            if (spinner) {
                spinner.style.display = 'none';
            }
            const videoPlayer = document.querySelector('.video-js');
            if (videoPlayer) {
                videoPlayer.classList.remove('hide-videojs-spinner');
            }
            clearTimeout(adTimeout); // Clear any existing ad timeout
        }

        function addCustomFullscreenButton() {
            const controlBar = player.getChild('controlBar');
            const fullscreenButton = document.createElement('button');
            fullscreenButton.className = 'vjs-fullscreen-control vjs-control vjs-button';
            fullscreenButton.innerHTML = '<i class="bi bi-arrows-fullscreen"></i>';
            fullscreenButton.setAttribute('aria-label', 'Fullscreen');

            fullscreenButton.addEventListener('click', function() {
                toggleFullscreen();
            });

            controlBar.el().insertBefore(fullscreenButton, controlBar.el().firstChild);
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                requestFullscreen(document.documentElement);
            } else {
                exitFullscreen();
            }
        }

        function requestFullscreen(element) {
            if (element.requestFullscreen) {
                element.requestFullscreen({ navigationUI: 'auto' })
                    .then(() => {
                        console.log('Fullscreen mode entered');
                    })
                    .catch((err) => {
                        console.error(`Error attempting to enable fullscreen mode: ${err.message}`);
                    });
            } else if (element.webkitRequestFullscreen) { /* Safari */
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) { /* IE11 */
                element.msRequestFullscreen();
            }
        }

        function exitFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen()
                    .then(() => {
                        console.log('Fullscreen mode exited');
                    })
                    .catch((err) => {
                        console.error(`Error attempting to exit fullscreen mode: ${err.message}`);
                    });
            } else if (document.webkitExitFullscreen) { /* Safari */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE11 */
                document.msExitFullscreen();
            }
        }

        function handleDocumentFullscreenChange() {
            const isFullscreen = !!document.fullscreenElement;

            if (player) {
                if (isFullscreen) {
                    player.addClass('vjs-fullscreen');
                } else {
                    player.removeClass('vjs-fullscreen');
                }
            }
        }

        function handleFullscreenError() {
            console.error('An error occurred while attempting to change fullscreen mode.');
        }

        document.addEventListener('DOMContentLoaded', async function() {
            await initializePlayer();
        });
    </script>
</body>
</html>
