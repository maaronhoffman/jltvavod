<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.6.8/plyr.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #player {
            width: 100%;
            height: 100%;
        }
        .episode-name-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            z-index: 10;
        }
        .show-title-player {
            font-size: 24px;
            margin: 0 0 5px 0;
            font-weight: bold;
        }
        .episode-title-player {
            font-size: 18px;
            color: #ccc;
        }
    </style>
</head>
<body>
    <div id="player-container">
        <video id="player" playsinline controls>
            <source src="{{ episode_url }}" type="application/x-mpegURL">
        </video>
        <div id="episode-name" class="episode-name-overlay">
            <h1 class="show-title-player">{{ show.name }}</h1>
            <h2 class="episode-title-player">{{ episode.name }}</h2>
        </div>
    </div>

    <script src="https://cdn.plyr.io/3.6.8/plyr.polyfilled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('player');
            const episodeNameOverlay = document.getElementById('episode-name');

            let hls;
            if (Hls.isSupported()) {
                hls = new Hls();
                hls.loadSource('{{ episode_url }}');
                hls.attachMedia(video);
            }

            const player = new Plyr(video, {
                ads: {
                    enabled: true,
                    tagUrl: 'https://obs.ads.ottera.tv/v1/s2s-hb?site_id=49382&site_page=[SITE_PAGE]&format=vast&pod_duration=[POD_DURATION]&cb=[CACHEBUSTER]&ip=[IP]&ua=[UA]&player_height=[HEIGHT]&player_width=[WIDTH]&is_lat=[LIMITED_AD_TRACKING]&site_name=[CHANNEL_NAME]&content_cat=[CONTENT_CAT]&content_channel=[CONTENT_CHANNEL]&content_context=[CONTENT_CONTEXT]&content_dist_id=[CONTENT_DIST_ID]&content_dist_name=[CONTENT_DIST_NAME]&content_episode=[CONTENT_EPISODE]&content_genre=[CONTENT_GENRE]&content_id=[CONTENT_ID]&content_keywords=[CONTENT_KEYWORDS]&content_language=[CONTENT_LANGUAGE]&content_length=[CONTENT_LENGTH]&content_network=[CONTENT_NETWORK]&content_prodqual=[CONTENT_PROD]&content_producer_id=[CONTENT_PRODUCER_ID]&content_producer=[CONTENT_PRODUCER_NAME]&content_rating=[CONTENT_RATING]&content_season=[CONTENT_SEASON]&content_series=[CONTENT_SERIES]&content_title=[CONTENT_TITLE]&content_url=[CONTENT_URL]&buyeruid=[BUYERUID]&us_privacy=[US_PRIVACY]&consent=[CONSENT]&coppa=[COPPA]&custom_5=[CUSTOM_5]&custom_6=[CUSTOM_6]&custom_7=[CUSTOM_7]&custom_8=[CUSTOM_8]&custom_9=[CUSTOM_9]&custom_10=[CUSTOM_10]&custom_11=[CUSTOM_11]&custom_12=[CUSTOM_12]&custom_13=[CUSTOM_13]&custom_14=[CUSTOM_14]&custom_15=[CUSTOM_15]&custom_16=[CUSTOM_16]&custom_17=[CUSTOM_17]&custom_18=[CUSTOM_18]&device_language=[DEVICE_LANGUAGE]&lat=[LAT]&lon=[LON]&device_type=[DEVICE_TYPE]&gdpr=[GDPR]&gender=[GENDER]&genre_id=[GENRE_ID]&ifa_type=[IFA_TYPE]&iris_context=[IRIS_CONTEXT]&iris_id=[IRIS_ID]&livestream=[LIVESTREAM]&max_bitrate=[MAXBITRATE]&min_bitrate=[MINBITRATE]&partner_domain=[PARTNER_DOMAIN]&position=[POSITION]&preferred_language=[PREFERRED_LANGUAGE]&rights_holder=[RIGHTS_HOLDER]&ssai_enabled=[SSAI_ENABLED]&ssai_vendor=[SSAI_VENDOR]&session_id=[SESSION_ID]&schain=[SCHAIN]&yob=[YOB]'
                }
            });

            const scteMarkers = {{ scte_markers|safe }};
            let lastPlayedCuePoint = -1;

            player.on('timeupdate', () => {
                const currentTime = player.currentTime;
                scteMarkers.forEach((marker, index) => {
                    if (currentTime >= marker.time && index > lastPlayedCuePoint) {
                        lastPlayedCuePoint = index;
                        player.pause();
                        player.ads.play();
                    }
                });
            });

            player.on('play', () => {
                episodeNameOverlay.style.display = 'block';
                setTimeout(() => {
                    episodeNameOverlay.style.display = 'none';
                }, 3000);
            });

            player.on('pause', () => {
                episodeNameOverlay.style.display = 'none';
            });

            player.on('adsready', () => {
                console.log('Ads are ready to be played');
            });

            player.on('adserror', (error) => {
                console.error('Ad error:', error);
            });
        });
    </script>
</body>
</html>
