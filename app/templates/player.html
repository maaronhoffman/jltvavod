<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Metadata and stylesheets -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player</title>
    <!-- Video.js and HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://vjs.zencdn.net/7.10.2/video-js.min.css" rel="stylesheet">
    <script src="https://vjs.zencdn.net/7.10.2/video.min.js"></script>
    <!-- IMA SDK -->
    <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
    <!-- Custom styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .video-js {
            width: 100% !important;
            height: 100% !important;
        }
        .video-js .vjs-big-play-button {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .vjs-controls-hidden .vjs-control-bar {
            display: none !important;
        }
        .vjs-control-bar {
            padding-top: 15px;
            padding-bottom: 15px;
            background-color: rgba(26, 26, 26, 0.7) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            height: 60px !important;
        }
       
        .video-js .vjs-play-progress {
            background-color: #00a0ff;
        }
        .video-js .vjs-progress-holder {
            background-color: rgba(255, 255, 255, 0.3);
        }
        .show-title-player {
            font-size: 24px;
            margin: 0 0 5px 0;
            margin-top: 20px;
            color: white;
            font-weight: bold;
        }
        .episode-title-player {
            font-size: 18px;
            margin-top: -12px;
            color: #ccc;
        }
.video-js .vjs-big-play-button .vjs-icon-placeholder:before {
    content: '' !important;
    background-image: url('/static/images/play.svg');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    border: none !important;
    width: 200px;
    height: 200px;
}

.video-js .vjs-big-play-button {
background-color: transparent;
width: 200px;
height: 200px;
border-color: transparent;
    
}
        .video-js.vjs-has-autoplay .vjs-big-play-button {
            display: none !important;
        }

    </style>
</head>
<body>
    <div id="video-container">
        <video id="my-video" class="video-js" controls preload="auto">
            <source src="{{ episode_url }}" type="application/x-mpegURL">
        </video>
        <div id="episode-name" class="episode-name-overlay">
            <div class="show-info-header">
                <h1 class="show-title-player">{{ show.name }}</h1>
                <h2 class="episode-title-player">{{ episode.name }}</h2>
            </div>
        </div>
        <div id="ad-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000;"></div>
    </div>

    <script>
        const IMA_SDK_URL = 'https://imasdk.googleapis.com/js/sdkloader/ima3.js';
        const MAX_RETRIES = 3;
        let adPlayed = false;
        let player, adContainer, adPlaying, scteMarkers, adsManager, adsLoader, lastPlayedCuePoint;
        let imaSDKLoaded = false;
        let mouseTimer;
        const adRequestQueue = [];
        let sessionId;
        let savedTime;
        let prerollRequested = false;
        let adDisplayContainerInitialized = false;

        function generateSessionId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function initializePlayer() {
            let isMobileDevice = isMobile();

            player = videojs('my-video', {
                autoplay: !isMobileDevice, // On mobile devices, do not autoplay
                muted: !isMobileDevice, // On mobile devices, do not mute
                controls: true,
                fullscreen: {
                    enabled: false
                }
            });

            adContainer = document.getElementById('ad-container');
            adContainer.style.display = 'none';
            adPlaying = false;
            adPlayed = false;
            scteMarkers = {{ scte_markers|safe }};
            lastPlayedCuePoint = -1;
            sessionId = generateSessionId();
            adRequestQueue.length = 0;

            player.on('timeupdate', handleTimeUpdate);
            player.on('seeking', handleSeeking);

            loadIMASDK(initIMA);
            const episodeNameOverlay = document.getElementById('episode-name');
            const episodeNameH2 = episodeNameOverlay.querySelector('h2');
            episodeNameH2.textContent = "{{ episode.name }}";
            console.log("Set episode name:", episodeNameOverlay.textContent);

            player.ready(function() {
                player.on('play', function() {
                    if (!adDisplayContainerInitialized) {
                        if (adDisplayContainer && adDisplayContainer.initialize) {
                            adDisplayContainer.initialize();
                            adDisplayContainerInitialized = true;
                        }
                    }
                    if (!prerollRequested && scteMarkers.length > 0 && scteMarkers[0].time === 0) {
                        prerollRequested = true;
                        adPlaying = true;
                        player.pause();
                        requestAds();
                        return;
                    }
                    if (adPlaying) {
                        player.pause();
                    }
                    showEpisodeName();
                    setTimeout(hideEpisodeName, 3000);
                });
            });
            player.on('pause', hideEpisodeName);
            player.el().addEventListener('mousemove', handleMouseMove);
            player.el().addEventListener('mouseenter', handleMouseEnter);
            player.el().addEventListener('mouseleave', handleMouseLeave);
        }

        function handleMouseMove() {
            console.log("Mouse moved");
            showEpisodeName();
            resetMouseTimer();
        }

        function handleMouseEnter() {
            console.log("Mouse entered");
            showEpisodeName();
            resetMouseTimer();
        }

        function handleMouseLeave() {
            console.log("Mouse left");
            hideEpisodeName();
            clearTimeout(mouseTimer);
        }

        function resetMouseTimer() {
            console.log("Resetting mouse timer");
            clearTimeout(mouseTimer);
            mouseTimer = setTimeout(() => {
                console.log("Mouse timer expired");
                hideEpisodeName();
            }, 2000);
        }

        function showEpisodeName() {
            const episodeNameOverlay = document.getElementById('episode-name');
            episodeNameOverlay.style.opacity = '1';
        }

        function hideEpisodeName() {
            const episodeNameOverlay = document.getElementById('episode-name');
            episodeNameOverlay.style.opacity = '0';
        }

        function loadIMASDK(callback) {
            const script = document.createElement('script');
            script.src = IMA_SDK_URL;
            script.async = true;
            script.onload = () => {
                imaSDKLoaded = true;
                callback();
                processAdQueue();
            };
            script.onerror = () => {
                console.error("Failed to load IMA SDK");
            };
            document.head.appendChild(script);
        }

        function initIMA() {
            if (typeof google === 'undefined' || typeof google.ima === 'undefined') {
                return;
            }

            adDisplayContainer = new google.ima.AdDisplayContainer(adContainer);
            // Do not call adDisplayContainer.initialize() here

            adsLoader = new google.ima.AdsLoader(adDisplayContainer);
            adsLoader.addEventListener(
                google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
                onAdsManagerLoaded,
                false);
            adsLoader.addEventListener(
                google.ima.AdErrorEvent.Type.AD_ERROR,
                onAdError,
                false);
        }

        function getRandomIP() {
            const usRanges = [
                [172, 16, 0, 0],
            ];
            const range = usRanges[Math.floor(Math.random() * usRanges.length)];
            return range.map((num, index) => {
                if (index === 0) return num;
                return Math.floor(Math.random() * 256);
            }).join('.');
        }

        async function getCurrentIP(useRandom = true) {
            return getRandomIP();
        }

        async function requestAds() {
            if (!imaSDKLoaded) {
                adRequestQueue.push(true);
                return;
            }

            if (!adDisplayContainerInitialized) {
                console.warn("AdDisplayContainer not initialized yet");
                return;
            }

            const timestamp = Date.now();
            const cacheBuster = timestamp + Math.random().toString(36).substring(2);

            const currentIP = await getCurrentIP(true);

            let vastUrl = 'https://obs.ads.ottera.tv/v1/s2s-hb?site_id=49382&site_page=[SITE_PAGE]&format=vast&pod_duration=[POD_DURATION]&cb=[CACHEBUSTER]&ip=[IP]&ua=[UA]&player_height=[HEIGHT]&player_width=[WIDTH]&is_lat=[LIMITED_AD_TRACKING]&site_name=[CHANNEL_NAME]&content_cat=[CONTENT_CAT]&content_channel=[CONTENT_CHANNEL]&content_context=[CONTENT_CONTEXT]&content_dist_id=[CONTENT_DIST_ID]&content_dist_name=[CONTENT_DIST_NAME]&content_episode=[CONTENT_EPISODE]&content_genre=[CONTENT_GENRE]&content_id=[CONTENT_ID]&content_keywords=[CONTENT_KEYWORDS]&content_language=[CONTENT_LANGUAGE]&content_length=[CONTENT_LENGTH]&content_network=[CONTENT_NETWORK]&content_prodqual=[CONTENT_PROD]&content_producer_id=[CONTENT_PRODUCER_ID]&content_producer=[CONTENT_PRODUCER_NAME]&content_rating=[CONTENT_RATING]&content_season=[CONTENT_SEASON]&content_series=[CONTENT_SERIES]&content_title=[CONTENT_TITLE]&content_url=[CONTENT_URL]&buyeruid=[BUYERUID]&us_privacy=[US_PRIVACY]&consent=[CONSENT]&coppa=[COPPA]&custom_5=[CUSTOM_5]&custom_6=[CUSTOM_6]&custom_7=[CUSTOM_7]&custom_8=[CUSTOM_8]&custom_9=[CUSTOM_9]&custom_10=[CUSTOM_10]&custom_11=[CUSTOM_11]&custom_12=[CUSTOM_12]&custom_13=[CUSTOM_13]&custom_14=[CUSTOM_14]&custom_15=[CUSTOM_15]&custom_16=[CUSTOM_16]&custom_17=[CUSTOM_17]&custom_18=[CUSTOM_18]&device_language=[DEVICE_LANGUAGE]&lat=[LAT]&lon=[LON]&device_type=[DEVICE_TYPE]&gdpr=[GDPR]&gender=[GENDER]&genre_id=[GENRE_ID]&ifa_type=[IFA_TYPE]&iris_context=[IRIS_CONTEXT]&iris_id=[IRIS_ID]&livestream=[LIVESTREAM]&max_bitrate=[MAXBITRATE]&min_bitrate=[MINBITRATE]&partner_domain=[PARTNER_DOMAIN]&position=[POSITION]&preferred_language=[PREFERRED_LANGUAGE]&rights_holder=[RIGHTS_HOLDER]&ssai_enabled=[SSAI_ENABLED]&ssai_vendor=[SSAI_VENDOR]&session_id=[SESSION_ID]&schain=[SCHAIN]&yob=[YOB]&timestamp=[TIMESTAMP]';

            vastUrl = vastUrl.replace('[CACHEBUSTER]', cacheBuster);
            vastUrl = vastUrl.replace('[SESSION_ID]', sessionId);
            vastUrl = vastUrl.replace('[IP]', currentIP);
            vastUrl = vastUrl.replace('[TIMESTAMP]', timestamp);
            vastUrl = vastUrl.replace('[UA]', navigator.userAgent);
            vastUrl = vastUrl.replace('[HEIGHT]', player.el().offsetHeight);
            vastUrl = vastUrl.replace('[WIDTH]', player.el().offsetWidth);
            vastUrl = vastUrl.replace('[LIMITED_AD_TRACKING]', 'false');
            vastUrl = vastUrl.replace('[SITE_PAGE]', '{{ episode.name }}');

            const adsRequest = new google.ima.AdsRequest();
            adsRequest.adTagUrl = vastUrl;
            adsRequest.linearAdSlotWidth = player.el().offsetWidth;
            adsRequest.linearAdSlotHeight = player.el().offsetHeight;
            adsRequest.nonLinearAdSlotWidth = player.el().offsetWidth;
            adsRequest.nonLinearAdSlotHeight = player.el().offsetHeight;

            adsLoader.requestAds(adsRequest);
        }

        function processAdQueue() {
            while (adRequestQueue.length > 0) {
                adRequestQueue.shift();
                requestAds();
            }
        }

        function onAdsManagerLoaded(adsManagerLoadedEvent) {
            adsManager = adsManagerLoadedEvent.getAdsManager(player.el());
            adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED, onContentPauseRequested);
            adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED, onContentResumeRequested);
            adsManager.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, onAdError);
            adsManager.addEventListener(google.ima.AdEvent.Type.ALL_ADS_COMPLETED, onAllAdsCompleted);
            adsManager.addEventListener(google.ima.AdEvent.Type.COMPLETE, onAdEnded);

            try {
                adsManager.init(player.el().offsetWidth, player.el().offsetHeight, google.ima.ViewMode.NORMAL);
                adsManager.start();
            } catch (adError) {
                player.play();
            }
        }

        function onAdEnded() {
            if (adPlayed) {
                adContainer.style.display = 'none';
            }
            player.el().style.pointerEvents = 'auto';
            player.controls(true);
        }

        function onContentPauseRequested() {
            player.pause();
            player.tech_.el_.pause();
            player.muted(true);
            player.controls(false);
            player.el().style.pointerEvents = 'none';
            adContainer.style.display = 'block';
            adPlaying = true;
        }

        function onContentResumeRequested() {
            player.removeClass('vjs-controls-hidden');
            player.muted(false);
            player.controls(true);
            player.el().style.pointerEvents = 'auto';
            adContainer.style.display = 'none';
            adPlaying = false;
            if (savedTime !== undefined) {
                player.currentTime(savedTime);
                savedTime = undefined;
            }
            player.play();
        }

        function onAdError(adErrorEvent) {
            if (adsManager) {
                adsManager.destroy();
            }
            adPlaying = false;
            player.play();
        }

        function onAllAdsCompleted() {
            adPlaying = false;
            player.removeClass('vjs-controls-hidden');
            player.play();
        }

        function handleTimeUpdate() {
            if (adPlaying) {
                return;
            }
            const currentTime = player.currentTime();
            scteMarkers.forEach((marker, index) => {
                if (currentTime >= marker.time && index > lastPlayedCuePoint && !adPlaying) {
                    adPlaying = true;
                    lastPlayedCuePoint = index;
                    player.pause();
                    requestAds();
                }
            });
        }

        function handleSeeking() {
            const currentTime = player.currentTime();
            const bufferTime = 0.5;

            lastPlayedCuePoint = scteMarkers.findIndex(marker => marker.time > currentTime) - 1;
            lastPlayedCuePoint = Math.max(-1, Math.min(lastPlayedCuePoint, scteMarkers.length - 1));

            const nextCuePoint = scteMarkers[lastPlayedCuePoint + 1];
            if (nextCuePoint && currentTime >= nextCuePoint.time - bufferTime && !adPlaying) {
                player.pause();
                adPlaying = true;
                savedTime = currentTime;
                requestAds();
            }
        }

        window.addEventListener('resize', function() {
            if (adsManager) {
                adsManager.resize(player.el().offsetWidth, player.el().offsetHeight, google.ima.ViewMode.NORMAL);
            }
        });

        window.addEventListener('beforeunload', function() {
            adRequestQueue.length = 0;
            lastPlayedCuePoint = -1;
            sessionId = generateSessionId();
        });

        initializePlayer();
    </script>
</body>
</html>
